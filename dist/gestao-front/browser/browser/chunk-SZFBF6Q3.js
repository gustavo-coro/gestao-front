import{a as Le,b as je,c as He,d as Ge,e as ze,f as Ue,h as We}from"./chunk-ZUGG34OB.js";import"./chunk-MS4AQ6UA.js";import{a as Ae,b as Ne}from"./chunk-RYGSPGTT.js";import{a as Be,b as Re}from"./chunk-YF4REM46.js";import{a as Se,b as be}from"./chunk-YCVRZCX4.js";import{a as Ve,b as qe,c as $e}from"./chunk-JKG6SBN7.js";import{a as Me,b as Ee,c as ye,d as Fe,e as Ie,f as we,g as De,h as Pe,i as Te,j as ke,k as Oe}from"./chunk-QR3VN75N.js";import"./chunk-EKXEQYR4.js";import"./chunk-RK5QYF4B.js";import"./chunk-2AMZF5UH.js";import{A as pe,B as ce,F as ue,G as fe,b as U,d as _,f as W,g as Q,i as Y,j as Z,k as J,l as K,m as X,n as ee,o as te,q as ie,r as re,s as ne,t as me,u as le,w as se,x as de}from"./chunk-7FJALMHQ.js";import{a as oe,f as ae,g as xe}from"./chunk-XAYXIGTK.js";import{a as G,c as z}from"./chunk-GN7WWOTY.js";import{Ab as E,Bb as F,Cb as I,Da as m,Db as q,Eb as $,Fb as B,Ha as g,Hb as R,Ib as A,Kb as w,Mb as D,Oa as V,Ta as p,Za as l,a as P,ad as _e,b as T,cd as ge,dd as ve,ec as N,ed as he,fc as L,fd as Ce,gb as o,ha as v,hb as r,ia as h,ib as u,ic as j,jb as C,jc as H,kb as x,mb as y,ob as b,pb as f,yb as M,zb as a}from"./chunk-4P6AN2NL.js";var Ze=()=>({standalone:!0});function Je(i,e){i&1&&u(0,"mat-progress-bar",8)}function Ke(i,e){i&1&&(o(0,"mat-error"),a(1," Data da venda \xE9 obrigat\xF3ria "),r())}function Xe(i,e){if(i&1&&(o(0,"mat-option",33),a(1),r()),i&2){let t=e.$implicit,s=f(2);l("value",t.cpf_cnpj),m(),I(" ",t.nome," (",s.formatCpfCnpjForDisplay(t.cpf_cnpj),") ")}}function et(i,e){i&1&&(o(0,"mat-error"),a(1," Cliente \xE9 obrigat\xF3rio "),r())}function tt(i,e){if(i&1&&(o(0,"mat-option",33),a(1),r()),i&2){let t=e.$implicit;l("value",t.id_forma_pagamento),m(),F(" ",t.nome_forma_pagamento," ")}}function it(i,e){i&1&&(o(0,"mat-error"),a(1," Forma de pagamento \xE9 obrigat\xF3ria "),r())}function rt(i,e){if(i&1&&(o(0,"mat-option",33),a(1),r()),i&2){let t=e.$implicit;l("value",t.cpf),m(),I(" ",t.nome," (",t.cpf,") ")}}function nt(i,e){i&1&&(o(0,"mat-error"),a(1," Funcion\xE1rio \xE9 obrigat\xF3rio "),r())}function ot(i,e){i&1&&(o(0,"mat-error"),a(1," Valor \xE9 obrigat\xF3rio "),r())}function at(i,e){i&1&&(o(0,"mat-error"),a(1," Valor deve ser maior que zero "),r())}function mt(i,e){if(i&1&&(o(0,"mat-option",33),a(1),w(2,"currency"),r()),i&2){let t=e.$implicit;l("value",t),m(),I(" ",t.nome_produto," - ",D(2,3,t.valor_venda,"BRL")," ")}}function lt(i,e){i&1&&(o(0,"th",48),a(1,"Produto"),r())}function st(i,e){if(i&1&&(o(0,"td",49),a(1),r()),i&2){let t=e.$implicit;m(),E(t.product.nome_produto)}}function dt(i,e){i&1&&(o(0,"th",48),a(1,"Pre\xE7o Unit\xE1rio"),r())}function pt(i,e){if(i&1&&(o(0,"td",49),a(1),w(2,"currency"),r()),i&2){let t=e.$implicit;m(),E(D(2,1,t.product.valor_venda,"BRL"))}}function ct(i,e){i&1&&(o(0,"th",48),a(1,"Quantidade"),r())}function ut(i,e){if(i&1){let t=y();o(0,"td",49)(1,"mat-form-field",50)(2,"input",51),B("ngModelChange",function(n){let d=v(t).$implicit;return $(d.quantity,n)||(d.quantity=n),h(n)}),b("ngModelChange",function(){v(t);let n=f(3);return h(n.updateTotalValue())}),r()()()}if(i&2){let t=e.$implicit;m(2),q("ngModel",t.quantity),l("ngModelOptions",A(2,Ze))}}function ft(i,e){i&1&&(o(0,"th",48),a(1,"Subtotal"),r())}function _t(i,e){if(i&1&&(o(0,"td",52),a(1),w(2,"currency"),r()),i&2){let t=e.$implicit;m(),F(" ",D(2,1,t.product.valor_venda*t.quantity,"BRL")," ")}}function gt(i,e){i&1&&(o(0,"th",53),a(1,"A\xE7\xF5es"),r())}function vt(i,e){if(i&1){let t=y();o(0,"td",54)(1,"button",55),b("click",function(){let n=v(t).index,d=f(3);return h(d.removeItem(n))}),o(2,"mat-icon"),a(3,"delete"),r()()()}}function ht(i,e){i&1&&u(0,"tr",56)}function Ct(i,e){i&1&&u(0,"tr",57)}function xt(i,e){if(i&1&&(o(0,"div",34)(1,"table",35),C(2,36),p(3,lt,2,0,"th",37)(4,st,2,1,"td",38),x(),C(5,39),p(6,dt,2,0,"th",37)(7,pt,3,4,"td",38),x(),C(8,40),p(9,ct,2,0,"th",37)(10,ut,3,3,"td",38),x(),C(11,41),p(12,ft,2,0,"th",37)(13,_t,3,4,"td",42),x(),C(14,43),p(15,gt,2,0,"th",44)(16,vt,4,0,"td",45),x(),p(17,ht,1,0,"tr",46)(18,Ct,1,0,"tr",47),r()()),i&2){let t=f(2);m(),l("dataSource",t.selectedItems),m(16),l("matHeaderRowDef",t.displayedColumns),m(),l("matRowDefColumns",t.displayedColumns)}}function St(i,e){if(i&1){let t=y();o(0,"form",9),b("ngSubmit",function(){v(t);let n=f();return h(n.onSubmit())}),o(1,"div",10)(2,"mat-form-field",11)(3,"mat-label"),a(4,"Data da Venda"),r(),u(5,"input",12)(6,"mat-datepicker-toggle",13)(7,"mat-datepicker",null,0),p(9,Ke,2,0,"mat-error",14),r(),o(10,"mat-form-field",11)(11,"mat-label"),a(12,"Nota Fiscal"),r(),u(13,"input",15),r()(),o(14,"div",10)(15,"mat-form-field",11)(16,"mat-label"),a(17,"Cliente"),r(),o(18,"mat-select",16),p(19,Xe,2,3,"mat-option",17),r(),o(20,"mat-icon",18),a(21,"person"),r(),p(22,et,2,0,"mat-error",14),r(),o(23,"mat-form-field",11)(24,"mat-label"),a(25,"Forma de Pagamento"),r(),o(26,"mat-select",19),p(27,tt,2,2,"mat-option",17),r(),o(28,"mat-icon",18),a(29,"credit_card"),r(),p(30,it,2,0,"mat-error",14),r()(),o(31,"div",10)(32,"mat-form-field",11)(33,"mat-label"),a(34,"Funcion\xE1rio"),r(),o(35,"mat-select",20),p(36,rt,2,3,"mat-option",17),r(),o(37,"mat-icon",18),a(38,"badge"),r(),p(39,nt,2,0,"mat-error",14),r(),o(40,"mat-form-field",11)(41,"mat-label"),a(42,"Valor Total"),r(),u(43,"input",21),o(44,"span",22),a(45,"R$\xA0"),r(),p(46,ot,2,0,"mat-error",14)(47,at,2,0,"mat-error",14),r()(),o(48,"div",23)(49,"h3",24),a(50,"Selecionar Produtos"),r(),o(51,"div",25)(52,"mat-form-field",26)(53,"mat-label"),a(54,"Produto"),r(),o(55,"mat-select",null,1),p(57,mt,3,6,"mat-option",17),r(),o(58,"mat-icon",18),a(59,"inventory_2"),r()(),o(60,"mat-form-field",27)(61,"mat-label"),a(62,"Quantidade"),r(),u(63,"input",28,2),r(),o(65,"button",29),b("click",function(){v(t);let n=M(56),d=M(64),S=f();return h(S.addItem(n.value,d.valueAsNumber||1))}),o(66,"mat-icon"),a(67,"add"),r(),a(68," Adicionar "),r()()(),p(69,xt,19,3,"div",30),o(70,"div",31)(71,"button",32)(72,"mat-icon"),a(73),r(),a(74),r()()()}if(i&2){let t,s,n,d,S,k,O=M(8),Ye=M(56),c=f();l("formGroup",c.form),m(5),l("matDatepicker",O),m(),l("for",O),m(3),l("ngIf",(t=c.form.get("data_venda"))==null?null:t.hasError("required")),m(10),l("ngForOf",c.customers),m(3),l("ngIf",(s=c.form.get("fk_cpf_cnpj_cliente"))==null?null:s.hasError("required")),m(5),l("ngForOf",c.payment_methods),m(3),l("ngIf",(n=c.form.get("fk_forma_pagamento"))==null?null:n.hasError("required")),m(6),l("ngForOf",c.employees),m(3),l("ngIf",(d=c.form.get("fk_cpf_funcionario"))==null?null:d.hasError("required")),m(7),l("ngIf",(S=c.form.get("valor_total"))==null?null:S.hasError("required")),m(),l("ngIf",(k=c.form.get("valor_total"))==null?null:k.hasError("min")),m(10),l("ngForOf",c.products),m(8),l("disabled",!Ye.value),m(4),l("ngIf",c.selectedItems.length>0),m(2),l("disabled",c.isLoading),m(2),E(c.isEdit?"save":"add"),m(),F(" ",c.isEdit?"Salvar":"Criar"," ")}}function bt(i,e){i&1&&(o(0,"div",58),u(1,"mat-spinner",59),r())}var Qe=class i{constructor(e,t,s,n,d,S){this.fb=e;this.api=t;this.router=s;this.route=n;this.dateAdapter=d;this.snackBar=S;this.dateAdapter.setLocale("pt-BR")}form;isEdit=!1;isLoading=!1;id;customers=[];payment_methods=[];employees=[];products=[];selectedItems=[];displayedColumns=["name","price","quantity","subtotal","actions"];ngOnInit(){this.initializeForm(),this.loadDropdownData(),this.loadProducts(),this.id=this.route.snapshot.paramMap.get("id")||void 0,this.id&&this.loadSaleData()}initializeForm(){this.form=this.fb.group({valor_total:["",[_.required,_.min(.01)]],data_venda:["",_.required],nota_fiscal:["",_.required],fk_cpf_cnpj_cliente:["",_.required],fk_forma_pagamento:["",_.required],fk_cpf_funcionario:["",_.required]})}loadDropdownData(){this.isLoading=!0,this.api.getCustomers().subscribe({next:e=>this.customers=e,error:e=>this.showError("Erro ao carregar clientes")}),this.api.getPayments().subscribe({next:e=>this.payment_methods=e,error:e=>this.showError("Erro ao carregar formas de pagamento")}),this.api.getEmployees().subscribe({next:e=>this.employees=e,complete:()=>this.isLoading=!1,error:e=>this.showError("Erro ao carregar funcion\xE1rios")})}loadSaleData(){this.isLoading=!0,this.isEdit=!0,this.api.getSale(this.id).subscribe({next:e=>{let t=e.data_venda?this.parseBackendDate(e.data_venda):null;this.form.patchValue(T(P({},e),{fk_cpf_cnpj_cliente:e.cliente?.cpf_cnpj,fk_cpf_funcionario:e.funcionario?.cpf,fk_forma_pagamento:e.forma_pagamento?.id_forma_pagamento,valor_total:String(e.valor_total),data_venda:t})),this.isLoading=!1},error:e=>{this.showError("Erro ao carregar venda"),this.isLoading=!1}})}loadProducts(){this.api.getProducts().subscribe({next:e=>{this.products=e},error:e=>this.showError("Erro ao carregar produtos")})}addItem(e,t){if(!e)return;let s=this.selectedItems.find(n=>n.product.id_produto===e.id_produto);s?s.quantity+=t:this.selectedItems=[...this.selectedItems,{product:e,quantity:t}],this.updateTotalValue()}removeItem(e){this.selectedItems.splice(e,1),this.selectedItems=[...this.selectedItems],this.updateTotalValue()}updateTotalValue(){let e=this.selectedItems.reduce((t,s)=>t+s.product.valor_venda*s.quantity,0);this.form.get("valor_total")?.setValue(e.toFixed(2))}onSubmit(){if(this.form.invalid||this.selectedItems.length===0){this.showError("Por favor, preencha todos os campos e adicione pelo menos um item");return}this.isLoading=!0;let e=T(P({},this.form.value),{valor_total:parseFloat(this.form.value.valor_total),fk_forma_pagamento:parseInt(this.form.value.fk_forma_pagamento),data_venda:this.convertToBackendFormat(this.form.value.data_venda),itens:this.selectedItems.map(s=>({fk_produto:s.product.id_produto,qtd_item_produto:s.quantity}))});console.log(e),(this.isEdit?this.api.updateSales(this.id,e):this.api.createSales(e)).subscribe({next:s=>{this.showSuccess("Venda salva com sucesso!"),this.router.navigate(["/vendas"])},error:s=>{this.showError("Erro ao salvar venda. Por favor, tente novamente."),this.isLoading=!1}})}showError(e){this.snackBar.open(e,"Fechar",{duration:5e3,panelClass:["error-snackbar"]})}showSuccess(e){this.snackBar.open(e,"Fechar",{duration:3e3,panelClass:["success-snackbar"]})}parseBackendDate(e){let t=new Date(e);return new Date(t.getUTCFullYear(),t.getUTCMonth(),t.getUTCDate())}convertToBackendFormat(e){if(!e)return"";let t=new Date(e);return t.setDate(t.getDate()+1),t.toISOString().split("T")[0]+"T00:00:00.000Z"}formatCpfCnpjForDisplay(e){if(!e)return"";let t=String(e).replace(/\D/g,"");if(t.length===0)return"";if(t.length<=11){let n=t.substring(0,11),d=n;return n.length>9?d=`${n.substring(0,3)}.${n.substring(3,6)}.${n.substring(6,9)}-${n.substring(9)}`:n.length>6?d=`${n.substring(0,3)}.${n.substring(3,6)}.${n.substring(6)}`:n.length>3&&(d=`${n.substring(0,3)}.${n.substring(3)}`),d}else{let n=t.substring(0,14),d=n;return n.length>12?d=`${n.substring(0,2)}.${n.substring(2,5)}.${n.substring(5,8)}/${n.substring(8,12)}-${n.substring(12)}`:n.length>8?d=`${n.substring(0,2)}.${n.substring(2,5)}.${n.substring(5,8)}/${n.substring(8)}`:n.length>5?d=`${n.substring(0,2)}.${n.substring(2,5)}.${n.substring(5)}`:n.length>2&&(d=`${n.substring(0,2)}.${n.substring(2)}`),d}}static \u0275fac=function(t){return new(t||i)(g(ie),g(xe),g(z),g(G),g(je),g(Be))};static \u0275cmp=V({type:i,selectors:[["app-sales-form"]],features:[R([We(),{provide:Le,useValue:"pt-BR"}])],decls:7,vars:4,consts:[["picker",""],["productSelect",""],["quantityInput",""],[1,"form-card"],[1,"form-header"],["mode","indeterminate","color","accent",4,"ngIf"],["class","form-content",3,"formGroup","ngSubmit",4,"ngIf"],["class","loading-overlay",4,"ngIf"],["mode","indeterminate","color","accent"],[1,"form-content",3,"ngSubmit","formGroup"],[1,"form-row"],["appearance","outline",1,"form-field"],["matInput","","formControlName","data_venda",3,"matDatepicker"],["matSuffix","",3,"for"],[4,"ngIf"],["matInput","","formControlName","nota_fiscal"],["formControlName","fk_cpf_cnpj_cliente","required",""],[3,"value",4,"ngFor","ngForOf"],["matSuffix",""],["formControlName","fk_forma_pagamento","required",""],["formControlName","fk_cpf_funcionario","required",""],["matInput","","formControlName","valor_total","type","number","readonly",""],["matPrefix",""],[1,"product-selection"],[1,"section-title"],[1,"product-controls"],["appearance","outline",1,"product-field"],["appearance","outline",1,"quantity-field"],["matInput","","type","number","min","1","value","1"],["mat-raised-button","","color","accent","type","button",1,"add-button",3,"click","disabled"],["class","selected-items mat-elevation-z4",4,"ngIf"],[1,"form-actions"],["mat-raised-button","","color","primary","type","submit",1,"submit-button",3,"disabled"],[3,"value"],[1,"selected-items","mat-elevation-z4"],["mat-table","",1,"full-width",3,"dataSource"],["matColumnDef","name"],["mat-header-cell","",4,"matHeaderCellDef"],["mat-cell","",4,"matCellDef"],["matColumnDef","price"],["matColumnDef","quantity"],["matColumnDef","subtotal"],["mat-cell","","class","text-right",4,"matCellDef"],["matColumnDef","actions"],["mat-header-cell","","class","text-center",4,"matHeaderCellDef"],["mat-cell","","class","text-center",4,"matCellDef"],["mat-header-row","",4,"matHeaderRowDef"],["mat-row","",4,"matRowDef","matRowDefColumns"],["mat-header-cell",""],["mat-cell",""],["appearance","outline",1,"quantity-input"],["matInput","","type","number","min","1",3,"ngModelChange","ngModel","ngModelOptions"],["mat-cell","",1,"text-right"],["mat-header-cell","",1,"text-center"],["mat-cell","",1,"text-center"],["mat-icon-button","","type","button","color","warn","matTooltip","Remover item",3,"click"],["mat-header-row",""],["mat-row",""],[1,"loading-overlay"],["diameter","50","color","accent"]],template:function(t,s){t&1&&(o(0,"mat-card",3)(1,"div",4)(2,"h2"),a(3),r(),p(4,Je,1,0,"mat-progress-bar",5),r(),p(5,St,75,18,"form",6)(6,bt,2,0,"div",7),r()),t&2&&(m(3),E(s.isEdit?"Editar Venda":"Nova Venda"),m(),l("ngIf",s.isLoading),m(),l("ngIf",!s.isLoading),m(),l("ngIf",s.isLoading))},dependencies:[H,N,L,j,ne,Z,U,J,W,Q,te,ee,K,X,ae,oe,ce,pe,me,le,se,de,fe,ue,ve,ge,_e,Ue,He,Ge,ze,Ce,he,$e,qe,Ve,Re,be,Se,Ne,Ae,Oe,Me,ye,De,Fe,Ee,Pe,Ie,we,Te,ke,re,Y],styles:[".form-card[_ngcontent-%COMP%]{max-width:800px;margin:2rem auto;padding:2rem;border-radius:16px;overflow:hidden}.form-header[_ngcontent-%COMP%]{margin-bottom:2rem}.form-header[_ngcontent-%COMP%]   h2[_ngcontent-%COMP%]{margin-bottom:.5rem}.form-content[_ngcontent-%COMP%]{display:flex;flex-direction:column;gap:1.5rem}.form-row[_ngcontent-%COMP%]{display:flex;gap:1.5rem}.form-row[_ngcontent-%COMP%]   .form-field[_ngcontent-%COMP%]{flex:1}.section-title[_ngcontent-%COMP%]{color:var(--primary-color);margin:1.5rem 0 1rem;font-size:1.2rem}.product-selection[_ngcontent-%COMP%]{background:#4361ee0d;padding:1.5rem;border-radius:12px;margin:1rem 0}.product-controls[_ngcontent-%COMP%]{display:flex;gap:1rem;align-items:flex-end}.product-field[_ngcontent-%COMP%]{flex:2}.quantity-field[_ngcontent-%COMP%]{flex:1;max-width:120px}.add-button[_ngcontent-%COMP%]{height:56px;margin-bottom:1.2rem}.selected-items[_ngcontent-%COMP%]{margin:1.5rem 0;border-radius:12px;overflow:hidden}.quantity-input[_ngcontent-%COMP%]{width:80px}.quantity-input[_ngcontent-%COMP%]   .mat-form-field-wrapper[_ngcontent-%COMP%]{padding-bottom:0}.quantity-input[_ngcontent-%COMP%]   .mat-form-field-underline[_ngcontent-%COMP%]{bottom:0}.form-actions[_ngcontent-%COMP%]{display:flex;justify-content:flex-end;gap:1rem;margin-top:1.5rem}.submit-button[_ngcontent-%COMP%]{min-width:120px}.cancel-button[_ngcontent-%COMP%]{border-color:var(--text-secondary);color:var(--text-secondary)}.loading-overlay[_ngcontent-%COMP%]{display:flex;justify-content:center;align-items:center;height:300px}@media (max-width: 768px){.form-row[_ngcontent-%COMP%]{flex-direction:column;gap:1rem}.product-controls[_ngcontent-%COMP%]{flex-direction:column;align-items:stretch}.quantity-field[_ngcontent-%COMP%], .product-field[_ngcontent-%COMP%]{max-width:100%}.add-button[_ngcontent-%COMP%]{width:100%;margin-bottom:0}.form-actions[_ngcontent-%COMP%]{flex-direction:column-reverse}.submit-button[_ngcontent-%COMP%], .cancel-button[_ngcontent-%COMP%]{width:100%}}"]})};export{Qe as SalesFormComponent};
